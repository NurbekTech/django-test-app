{% extends "layouts/base_layout.html" %}


{% block title %}{{ user.username }}{% endblock title %}

{% block base_layout %}
<div class="max-w-6xl mx-auto px-4 py-6 space-y-6">

    <!-- Profile / Progress Card -->
    <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 rounded-full overflow-hidden bg-gray-100 flex items-center justify-center">
                    {% if profile_user.avatar %}
                        <img src="{{ profile_user.avatar.url }}" class="w-full h-full object-cover" alt="avatar">
                    {% else %}
                        <span class="text-gray-400 text-sm">No avatar</span>
                    {% endif %}
                </div>

                <div>
                    <div class="text-xl font-semibold">
                        {{ profile_user.get_full_name|default:profile_user.username }}
                    </div>
                    <div class="text-sm text-gray-500">
                        {{ profile_user.email }}
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 rounded-xl px-4 py-3 min-w-55">
                <div class="text-sm text-gray-500">Жалпы орташа баға</div>
                <div class="text-2xl font-semibold">
                    {% if overall_avg is not None %}
                    {{ overall_avg|floatformat:2 }}
                    {% else %}
                    —
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            {% for s in section_progress %}
                <div class="border rounded-xl p-4">
                    <div class="flex items-center justify-between">
                        <div class="text-sm font-medium">{{ s.label }}</div>
                        <div class="text-sm text-gray-600">
                            {% if s.avg is not None %}{{ s.avg|floatformat:2 }}{% else %}—{% endif %}
                        </div>
                    </div>

                    <!-- progress bar (қарапайым визуал) -->
                    <div class="mt-3 h-2 bg-gray-100 rounded-full overflow-hidden">
                        {% if s.avg is not None %}
                            {# Егер avg 0..100 болса жақсы. Басқа шкала болса, кейін нормализация жасаймыз #}
                            <div class="h-2 bg-gray-800" style="width: {{ s.avg|floatformat:0 }}%;"></div>
                        {% else %}
                            <div class="h-2 bg-gray-200" style="width: 0%;"></div>
                        {% endif %}
                    </div>

                    <div class="mt-2 text-xs text-gray-500">
                        Орташа нәтиже
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Recent Attempts -->
    <div class="bg-white rounded-2xl shadow p-6">
        <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Соңғы тапсырылған тесттер</h2>
            <a href="#" class="text-sm text-gray-600 hover:text-gray-900">Барлығы</a>
        </div>

        <div class="mt-4 overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="text-left text-gray-500 border-b">
                    <tr>
                        <th class="py-3 pr-4">Тест</th>
                        <th class="py-3 pr-4">Күйі</th>
                        <th class="py-3 pr-4">Балл</th>
                        <th class="py-3 pr-4">Аяқталды</th>
                        <th class="py-3 pr-0"></th>
                    </tr>
                </thead>

                <tbody class="divide-y">
                    {% for a in recent_attempts %}
                    <tr class="hover:bg-gray-50">
                        <td class="py-3 pr-4">
                            <div class="font-medium">{{ a.exam.name }}</div>
                            <div class="text-xs text-gray-500">Attempt #{{ a.id }}</div>
                        </td>

                        <td class="py-3 pr-4">
                            <span class="px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-700">
                                {{ a.status }}
                            </span>
                        </td>

                        <td class="py-3 pr-4 font-medium">
                            {% if a.total_score is not None %}{{ a.total_score|floatformat:2 }}{% else %}—{% endif %}
                        </td>

                        <td class="py-3 pr-4 text-gray-600">
                            {% if a.finished_at %}{{ a.finished_at|date:"Y-m-d H:i" }}{% else %}—{% endif %}
                        </td>

                        <td class="py-3 pr-0 text-right">
                            <a href="{% url 'main:attempt_detail' a.id %}" class="text-sm font-medium text-gray-800 hover:underline">
                                Ашып көру
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td class="py-6 text-gray-500 text-center" colspan="5">
                            Әзірге тапсырылған тест жоқ.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>
{% endblock base_layout %}