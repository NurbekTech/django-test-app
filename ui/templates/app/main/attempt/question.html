{% extends "layouts/base_layout.html" %}
{% load static %}

{% block title %}{{ attempt.exam.title }}{% endblock title %}

{% block base_layout %}
<div class="max-w-6xl mx-auto py-4">
    <div class="grid gap-4">
        <div id="question-header" class="flex gap-2 p-2 rounded-2xl overflow-x-auto w-full">
            {% for qq in flat_questions %}
                {% if qq.id == q.id %}
                    <div
                        class="w-10 h-10 flex items-center justify-center rounded-xl border-2 border-indigo-600 bg-indigo-50 font-bold">
                        {{ forloop.counter }}
                    </div>
                {% elif qq.id in answered_q_ids %}
                    <div
                        class="w-10 h-10 flex items-center justify-center rounded-xl border border-green-300 bg-green-50 text-green-700 font-semibold">
                        {{ forloop.counter }}
                    </div>
                {% else %}
                    <div class="w-10 h-10 flex items-center justify-center rounded-xl border bg-gray-50 text-gray-700">
                        {{ forloop.counter }}
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <div class="grid gap-4 w-full max-w-4xl mx-auto">
            <div id="section-material">
                {% if current_section and current_section.material %}
                    <div class="border border-border-200 rounded-2xl p-4">
                        <div class="text-lg font-semibold">
                            {{ current_section.get_section_type_display }}
                        </div>
                    
                        {% if current_section.material.text %}
                            <div class="mt-4 whitespace-pre-line">
                                {{ current_section.material.text|safe }}
                            </div>
                        {% endif %}
                    
                        {% if current_section.material.audio %}
                            <div class="mt-4">
                                <audio controls class="w-full">
                                    <source src="{{ current_section.material.audio.url }}">
                                </audio>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <div
                id="question-panel"
                class="grid gap-4 border border-border-200 rounded-2xl p-4"
            >
                <div class="flex items-center justify-between">
                    <div class="font-medium text-muted">Сұрақ {{ q_index }} / {{ q_total }}</div>
                    {% if saved %}
                        <span class="text-xs px-2 py-1 rounded-full bg-green-50 border border-green-200 text-green-700">
                            Сақталды ✅
                        </span>
                    {% endif %}
                </div>

                <div class="flex gap-2 items-start text-base font-semibold">
                    <span>{{ q.order }}. </span>
                    <div>{{ q.prompt|safe }}</div>
                </div>

                <form 
                    hx-post="{% url 'customer:attempt_answer' attempt.id q.id %}" 
                    hx-target="#question-panel" 
                    hx-swap="innerHTML"
                >
                    {% csrf_token %}
                    <input type="hidden" name="next_qid" value="{{ next_qid|default:'' }}">

                    {% include "app/main/attempt/partials/question_block.html" with q=q selected_set=selected_set %}

                    <div class="mt-4 flex items-center justify-between">
                        {% if prev_qid %}
                            <button 
                                type="button"
                                hx-get="{% url 'customer:attempt_question' attempt.id %}?section={{ current_section.id }}&q={{ prev_qid }}"
                                hx-target="#question-panel" 
                                hx-swap="innerHTML"
                                class="px-4 py-2 rounded-xl border bg-white hover:bg-secondary-100"
                            >
                                Артқа
                            </button>
                        {% else %}
                            <button 
                                type="button" 
                                disabled
                                class="px-4 py-2 rounded-xl border bg-secondary-100 text-muted cursor-not-allowed"
                            >
                                Артқа
                            </button>
                        {% endif %}

                        {% if next_qid %}
                            <button 
                                type="submit" 
                                class="px-4 py-2 rounded-xl bg-primary-600 text-white text-sm font-medium"
                            >
                                Келесі
                            </button>
                        {% else %}
                            <button 
                                type="submit" 
                                formaction="{% url 'customer:attempt_submit' attempt.id %}" 
                                formmethod="post"
                                class="px-4 py-2 rounded-xl bg-primary-600 text-white text-sm font-medium"
                            >
                                Тестті аяқтау
                            </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock base_layout %}