{% load dict_extras %}

{% with qa=qa_by_qid|get_item:q.id %}
  <form method="post" action="{% url 'main:attempt_answer' attempt.id q.id %}">
    {% csrf_token %}

    <div class="space-y-2">
        {% for opt in q.options.all %}
            {% with selected_set=selected_map|get_item:qa.id %}
                {% with is_selected=opt.id|in_set:selected_set %}
                    {% with correct_set=correct_map|get_item:q.id %}
                        {% with is_correct=opt.id|in_set:correct_set %}
                            <label 
                                class="
                                    flex items-start gap-3 p-3 rounded-xl border cursor-pointer
                                    {% if mode == 'review' and is_correct %} bg-green-50 border-green-200 {% endif %}
                                    {% if mode == 'review' and is_selected and not is_correct %} bg-red-50 border-red-200 {% endif %}
                                    {% if mode == 'take' and is_selected %} bg-gray-50 {% endif %}
                                "
                            >
                                <input 
                                    type="radio" name="option" value="{{ opt.id }}"
                                    {% if mode == "review" %}disabled{% endif %}
                                    {% if is_selected %}checked{% endif %}
                                    {% if readonly %}disabled{% endif %}
                                    class="mt-1" 
                                />
                                <div class="text-sm">{{ opt.text }}</div>
                            </label>
                        {% endwith %}
                    {% endwith %}
                {% endwith %}
            {% endwith %}
        {% endfor %}
    </div>

    {% if mode == "take" and not readonly %}
        <button 
            type="submit"
            class="mt-3 px-4 py-2 rounded-xl bg-gray-900 text-white text-sm font-medium hover:opacity-90"
        >
            Жауапты сақтау
        </button>
    {% endif %}
  </form>
{% endwith %}